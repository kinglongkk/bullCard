{"version":3,"sources":["assets\\Script\\Common\\Managers\\HTTPMgr.js"],"names":["http","cc","Class","_list_request","_isRequesting","_isAddHeart","_failTime","_time_timeOut","_timeOutID","_dict_longWait","_sessionID","properties","ctor","_nativeHref","G_Config_common","nativeHref","sendHttpRequest","url","sendData","callFunc","xhrType","addHeart","_recordSend","_dict_sendRequest","sendObj","G_OBJ","data_httpSend","_doNext","_sendRequest","xhr","XMLHttpRequest","self","onreadystatechange","status","_endRequest","_receiveData","needUrl","sys","isNative","setRequestHeader","open","send","GG","getIsLoading","topTouchLayer","showNetRequest","_addTimeOut","readyState","response","responseText","indexOf","JSON","parse","_checkLongWait","e","getIsRequesting","closeNetRequest","_cancelTimeOut","setTimeout","G_DATA","isNumber","clearTimeout","isRequesting","_this","setInterval","timedRefresh","G_DIALOG_URL","timedRefreshUrl","t","Date","data","bind","addLongRequestWait","module","exports"],"mappings":"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","file":"unknown","sourcesContent":["//http请求管理\r\n\r\nvar http = cc.Class({\r\n    _list_request : null,                                                                                               //请求列表\r\n    _isRequesting : null,                                                                                               //正在请求中\r\n    _isAddHeart : null,                                                                                                 //是否有心跳\r\n    _failTime : null,                                                                                                   //多长时间请求失败\r\n\r\n    _time_timeOut : null,                                                                                               //超时时间\r\n    _timeOutID : null,                                                                                                  //超时预计的ID\r\n    _dict_longWait : null,                                                                                              //长时间等待的请求\r\n    _sessionID : null,\r\n    properties: {\r\n\r\n    },\r\n\r\n    // use this for initialization\r\n    ctor: function () {\r\n        this._list_request = [];\r\n        this._isRequesting = false;\r\n        this._isAddHeart = false;\r\n        this._nativeHref = G_Config_common.nativeHref;\r\n    },\r\n\r\n    //發送請求\r\n    sendHttpRequest : function (url, sendData, callFunc, xhrType) {\r\n        this.addHeart();\r\n        this._recordSend(url, sendData, callFunc, xhrType)\r\n    },\r\n\r\n    //记录发送的信息\r\n    _recordSend : function (url, sendData, callFunc, xhrType) {\r\n        if(!this._dict_sendRequest) this._dict_sendRequest = {};\r\n        var sendObj = G_OBJ.data_httpSend();\r\n        sendObj.url = url;\r\n        sendObj.sendData = sendData;\r\n        sendObj.callFunc = callFunc;\r\n        sendObj.xhrType = xhrType;\r\n        this._dict_sendRequest[url] = sendObj;\r\n\r\n        if(!this._isRequesting){\r\n            this._doNext();\r\n        }\r\n    },\r\n\r\n    //下一个请求\r\n    _doNext : function () {\r\n        var sendObj;\r\n        for(var url in this._dict_sendRequest){\r\n            sendObj = this._dict_sendRequest[url];\r\n            if(sendObj) {\r\n                this._sendRequest(sendObj.url, sendObj.sendData, sendObj.callFunc, sendObj.xhrType);\r\n                break;\r\n            }\r\n        }\r\n    },\r\n    //发送请求\r\n    _sendRequest : function (url, sendData, callFunc, xhrType) {\r\n        var xhr = new XMLHttpRequest();\r\n        var self = this;\r\n        xhr.onreadystatechange = function () {\r\n            if(xhr.status == 404){\r\n                //无效的请求地址\r\n                self._endRequest(url, null, callFunc);\r\n            }else {\r\n                // console.log('request url= '+url+'; return data= '+xhr.responseText)\r\n                self._receiveData(xhr, url, sendData, callFunc);\r\n            }\r\n        };\r\n        //是否本地\r\n        var needUrl = url;\r\n        if(!xhrType) xhrType = 'POST';\r\n        if(cc.sys.isNative){\r\n            needUrl = this._nativeHref + url;\r\n            xhr.setRequestHeader(\"User-Agent\", \"Chrome\");\r\n        }\r\n        xhr.open(xhrType, needUrl, true);\r\n        xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\r\n        if(this._sessionID) {\r\n            // console.log('附加cookie信息'+this._sessionID)\r\n            // var session = 'session={'+this._sessionID+'}'\r\n            // var session = this._sessionID +'';\r\n            // xhr.setRequestHeader(\"cookie\", session);\r\n            // xhr.setRequestProperty(\"cookie\", this._sessionID);\r\n        }\r\n        // xhr.setRequestHeader(\"Content-Type\", \"Access-Control-Allow-Headers:x-requested-with\");\r\n        // xhr.setRequestHeader(\"Content-Type\", \"Access-Control-Allow-Methods:POST\");\r\n        // xhr.setRequestHeader(\"Content-Type\", \"Access-Control-Allow-Origin:*\");\r\n        xhr.send(sendData);\r\n        this._isRequesting = true;\r\n        if(!GG.getIsLoading())GG.topTouchLayer.showNetRequest();\r\n        //增加超时处理\r\n        var self = this;\r\n        this._addTimeOut(function () {\r\n            self._endRequest(url, null, callFunc);\r\n        })\r\n    },\r\n\r\n    //接收到网络请求\r\n    _receiveData : function (xhr, url, sendData, callFunc) {\r\n        //if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\r\n        if (xhr.readyState == 4 && xhr.status == 200) {\r\n            var response = xhr.responseText;\r\n\r\n            if(url.indexOf('logout') > -1 || url.indexOf('login') > -1){\r\n                //xhr.responseText 是整个页面的HTML\r\n                // var cookieValue = xhr.getResponseHeader(\"Set-Cookie\");\r\n                // this._sessionID = cookieValue.substring(0, cookieValue.indexOf(';'));\r\n                // this._sessionID = xhr.getResponseHeader(\"Set-Cookie\").replace('SID=', '').split(';')[0];\r\n                // this._sessionID = xhr.getResponseHeader(\"Set-Cookie\");\r\n                // console.log('获取到sessionID= '+ this._sessionID)\r\n                response = true;\r\n            }else{\r\n                try {\r\n                    response = JSON.parse(xhr.responseText);\r\n                    // if(!response) response = true;\r\n\r\n                    this._checkLongWait(url, response);\r\n                }catch (e){\r\n                    response = null;\r\n                }\r\n            }\r\n            this._endRequest(url, response, callFunc);\r\n        }\r\n    },\r\n    //请求结束\r\n    _endRequest : function (url, response, callFunc) {\r\n        var sendObj = this._dict_sendRequest[url];\r\n        if(sendObj){\r\n            if(sendObj.callFunc){\r\n                sendObj.callFunc(response);\r\n                sendObj.callFunc = null;\r\n            }\r\n            delete this._dict_sendRequest[url];\r\n            if(!this.getIsRequesting()) GG.topTouchLayer.closeNetRequest();\r\n            this._cancelTimeOut();\r\n            this._isRequesting = false;\r\n            this._doNext();\r\n        }\r\n    },\r\n    //增加超时处理\r\n    _addTimeOut : function (callFunc) {\r\n        this._time_timeOut = 6000;\r\n        this._timeOutID = setTimeout(function () {\r\n            if(callFunc){\r\n                callFunc();\r\n                callFunc = null;\r\n            }\r\n        }, this._time_timeOut)\r\n    },\r\n    _cancelTimeOut : function () {\r\n        if(G_DATA.isNumber(this._timeOutID)){\r\n            clearTimeout(this._timeOutID);\r\n            this._timeOutID = null;\r\n        }\r\n    },\r\n    getIsRequesting : function () {\r\n        var isRequesting = false;\r\n        if(this._dict_sendRequest){\r\n            for(var url in this._dict_sendRequest){\r\n                isRequesting = true;\r\n                break\r\n            }\r\n        }\r\n        return isRequesting\r\n    },\r\n\r\n    //===========================\r\n\r\n\r\n    //增加http心跳\r\n    addHeart : function () {\r\n        if(this._isAddHeart) return;\r\n        this._isAddHeart = true;\r\n        var _this = this;\r\n        setInterval(function () {\r\n            _this.timedRefresh();\r\n        },900000);\r\n    },\r\n\r\n    timedRefresh : function () {\r\n        this.sendHttpRequest(G_DIALOG_URL.timedRefreshUrl, {t:new Date()}, function (data) {\r\n\r\n        }.bind(this));\r\n    },\r\n\r\n    //增加长监听的请求\r\n    addLongRequestWait : function (url, sendData, callFunc) {\r\n        if(!this._dict_longWait) this._dict_longWait = {};\r\n        var sendObj = G_OBJ.data_httpSend();\r\n        sendObj.url = url;\r\n        sendObj.sendData = sendData;\r\n        sendObj.callFunc = callFunc;\r\n        this._dict_longWait[url] = sendObj;\r\n    },\r\n    _checkLongWait : function (url, response) {\r\n        if(!this._dict_longWait || !this._dict_longWait[url]) return;\r\n        if(response && !this._dict_sendRequest[url]) {\r\n            var sendObj = this._dict_longWait[url];\r\n            if(sendObj && sendObj.callFunc){\r\n                sendObj.callFunc(response);\r\n                sendObj.callFunc = null;\r\n            }\r\n            delete this._dict_sendRequest[url]\r\n        }\r\n\r\n    },\r\n\r\n    // called every frame, uncomment this function to activate update callback\r\n    // update: function (dt) {\r\n\r\n    // },\r\n});\r\n\r\nmodule.exports = http;"]}